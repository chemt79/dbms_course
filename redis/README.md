# HASH-хранилища (на примере Redis)

[Презентация](https://docs.google.com/presentation/d/1JrHtPtWotlV2naYGKmDh2MmwNsu1SYgmRQwgsXtAOW4/edit?usp=sharing)

В данном разделе представлена краткая карта-справочник, которая предназначена для более простого ориентирования в данной теме. 

## Содержание

1. [Введение](#Введение)
2. [Подготовка окружения](#Подготовка-окружения)
4. [Модель данных](#Модель-данных)
5. [Механизм сообщений](#Механизм-сообщений)
6. [Скрипты Lua](#Скрипты-lua)
7. [Модули](#Модули)
8. [Протокол взаимодействия](#Протокол-взаимодействия)
9. [Кластер](#Кластер)

## Введение

Хеш-хранилища представляют отдельный класс СУБД, которые, в основном, используются как вспомагательные
инструменты, как правило, в качестве кеша или для хранения промежуточных данных.
Основная идея подобного хранилища - адресация элементов множества при помощи хеш-функции.
Говоря простыми словами, данные хранятся в виде элементов-пар, которые состоят из ключа и, собственно,
самого знаения. Ключ - это, как правило, строка, которая превращается в число-адрес в массиве
при помощи хэш-функции, и по полученному адресу сохраняется значение. Выборка происходит аналогично, строка
ключа преобразуется в адрес, на основе которого считываются данные. Время выборки и записи практически не
зависит от кол-ва элементов в массиве данных (влияет только кол-во конфликтов). И большинстве случаев временная
сложность алгоритма, для записи и чтения в хеш-хранилище, равна O(1), что означает, время доступа не зависит от объема данных.
В отличии от времени выборки значений по индексу, где временная сложность равна O(log n), которая имеет
логарифмическую зависимость вермени от кол-ва элементов в массиве.  

Рассматриваемая СУБД Redis, один из наиболее популярных и функциональных представителей данного касса
программных продуктов. Redis не совсем правильно называть просто хеш-хранилищем, он несколько больше чем
простое хеш-хранилище. Если большинство хеш-хранилищ работают с неструктурированными
данными, то Redis - это хэш-хранилище структур данных, таких как: строки, списки, словари, множества,
сортированные множества; также Redis позволяет на основе списков организовать очередь и возможностью блокировки. 
СУБД Redis это гибридное решение, которое объединяет в себе функциональность in-memory и персистентных 
хранилищ одновременно. Это позволяет достичь очень высоких показателей в общей производительности системы
и позволет организовать быстрое восстановление после сбоя, конечно же не без компромиссов между надежностью и 
скоростью.
 
## Подготовка окружения

Для использования в окружении разработчика, и просто, для проведения экспериментов, будет достаточно развернуть
СУБД Redis на основе Docker-контейнера.

```sh
# Создаем том для данных
$ docker volume create redis_data
```

```sh
# Запускаем контейнер с СУБД
$ docker run -n redis-server -p 6379:6379 -v redis_data:/usr/lib/redis redis:latest
```

```sh
# Запускаем клиент
$ docker exec -it redis-server redis-cli
```

## Модель данных

### База данных

Базы данных в Redis не имеют строковых имен, а просто нумеруются по порядку. Чтобы сделать активной нужную БД
достаточно выполнить команду:

```
> select N
```

где N - номер необходимой БД.
БД является контейнером для пар ключ-значение.

### Пары ключ-значение

Все данные в БД хранятся по адресам, которые называются ключи. Ключ представляет собой обычную строку, на основе
которой, при помощи хеш-функции получается адрес хранения данных. Так как ключи представляют собой текстовые строки,
то их принято группировать по доменам следующим образом:

```
# Записать "{name: John, salary: 1000}" по ключу employees:office:1 
> set employees:office:1 "{name: John, salary: 1000}"
```

Домены ключа разделяются двоеточием, хотя это не является обязательными, просто это общепринятая практика.
Чтобы получить записанное по ключу значение, достаточно выполнить команду:

```
# Получить значение, которое хранится по ключу employees:office:1 
> get employees:office:1

Результат: "{name: John, salary: 1000}"
```

### Типы значений

Redis позволяет хранить данные просто, как набор байтов, но также, он предоставляет для пользователя пять
типов/структур данных, для организации хранения значений в структурированном виде.

* Строки
* Хеш-таблица
* Списки
* Множества
* Упорядоченные множества

#### Строки (STRING)

Строки относятся к примитивным типам данных. Redis предоставляет команды для работы со строками, ознакомится
с которыми можно по [ссылке](https://redis.io/commands/#string).

#### Хеш-таблица/Словари (HASH)

Хеш-таблица или словарь представляет собой хранилище пар ключ-значение. Redis не позволяет
создавать вложенные хеш-таблицы. Максимальное кол-во ключей в хеше 2^32 - 1.

```
# Записать пару (salary, 10000) по ключу users:max 
> hset users:max salary 10000
# Считать значение из хешь-таблицы по ключу salary
> hget users:max salary
"10000"
```

Ознакомится полностью с набором команд для работы с хеш-таблицами можно [здесь](https://redis.io/commands#hash) 

#### Списки (LIST)

Спиcки - классическая структура данных "Связанный список". Redis позволяет вставлять значение в список, как слева,
так и справа. Максимальная длинна списка 2^32 - 1.

```
# Запись в список
> RPUSH users:mike a # after that Mike will contain "a"
> RPUSH users:mike b # after that Mike will contain "a" "b"
> LPUSH users:mike z # after that Mike will contain "z a b"
```

```
# Чтение из списока
> RPOP users:mike # after that Mike will contain "z" "a"
"b"
> LPOP users:mike # after that Mike will contain "a"
"z"
```
На основе списков в Redis можно организовать блокирующиеся очереди. 
Для работы со списками Redis предоставляет достаточно много команд, ознакомиться с которыми можно по
[ссылке](https://redis.io/commands#list)

#### Множества (SET)
 
Множества передставляют собой набор не упорядоченных значений. Мaксимальное кол-во значений в множестве 2^32 - 1.

```
# Запись в множество
> SADD user:carl a # after that Mike will contain a
> SADD user:carl b # after that Mike will contain b a или a b
```

```
# Вернуть все члены множества
> SMEMBERS user:carl
"a" "b" 
```

Redis пердоставляет достаточно большой набор команд для работы с множествами, ознакомиться с которыми можно
[здесь](https://redis.io/commands#set)

#### Упроядоченные множества (SORTED SET)

По сути, упорядоченное множество - это обычный массив, т.е. обращатся к элементам можно по индексу.
Упорядоченные множества имеют такие же ограничения, как и обычные множества.

```
# Запись в множество
> ZADD user:carl a # after that Mike will contain a
> ZADD user:carl b # after that Mike will contain a b
```

```
# Вернуть члены множества c индекса по индекс
> ZRANGE user:carl 1 2
"a" "b" 
```

Ознакомиться с полным списком команд для работы с упорядоченными множествами можно
[здесь](https://redis.io/commands#sorted_set)

## Механизм сообщений

Redis предоставляет встроенный механизм сообщений типа Pub/Sub. Более подробно можно прочитать
[здесь](https://redis.io/topics/pubsub)

## Скрипты Lua

Redis позволяет выполнять обработку данных на стороне сервера при помощи интерпретатора языка Lua.
Для этого используется команда EVAL, которая принимает первым параметром скрипт на языке LUA,
далее кол-во передаваемых ключей, ключи и произвольные параметры. Другими словами вы создаете свою собственную команду Redis на 
языке Lua. Передаваемые ключи доступны внутри скрипта Lua, как элементы глобального массива KEY, а простые параметры в массиве ARGV.
Доступ к командам Redis из скрипта Lua осуществляется командами redis.call() и redis p.call(). 

```
> eval "return redis.call('set','foo','bar')" 0
OK
```

Более подробно можно почитать [здесь](https://redis.io/commands/eval)

## Модули

В случае, когда вам нужно расширить функциональность Redis, добавить новые высокопроизводительные команды, вы можете
исползовать механизм модулей. Модули оформляются в виде разделяемой библиотеки и подключаются к Redis.
Более подробно можно прочитать [здесь](https://redis.io/topics/modules-intro)

## Протокол взаимодействия

Протокол взаимодействия с сервером Redis представляет собой простой обмен текстовыми сообщениями в определенном формате.
Он очень прост и хорошо подходит для быстрого парсинга. Прочитать о нем можно
[здесь](https://redis.io/topics/protocol)

## Кластер

Кластеризация в СУБД Redis не самая сильная ее сторона. Существуют, как стандартные решения так и частные.
Более подробно о кластеризации Redis можно прочитать в этой [статье](https://redis.io/topics/cluster-tutorial)
