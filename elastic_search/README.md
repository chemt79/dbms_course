# Поисковые движки (на примере ElasticSearch)

[Презентация](https://docs.google.com/presentation/d/1Nn4R3DbWWaW843h_BfuqHpJxqp_GeSUEO-d9Xy0vfwI/edit?usp=sharing)

В данном разделе представлена краткая карта-справочник, которая предназначена для ориентирования 
в структуре ElasticSearch на самом примитивном уровне, однако, данного уровня будет вполне достаточно
для выполнения большинства повседневных задач. ElasticSearch имеет очень хорошую документацию, углубившись в 
которую, вы сможете найти ответы на большую часть вопросов, которые будут возникать у Вас в процессе освоения ElsaticSearch.
Я не вижу большой необходимости переписывать содержимое официальной документации здесь, поэтому, в данном документе объясняются
основные термины и концепции, а более подробная информация расположена по ссылкам имеющимся в каждой главе.

## Содержание

1. [Введение](#Введение)
2. [Подготовка окружения](#Подготовка-окружения)
3. [Архитектура](#Архитектура)
   * [Топология кластера](#Топология-кластера)
   * [Внутреннеe устройство ноды](#Внутреннеe-устройство-ноды)
4. [Модель данных](#Модель-данных)
   * [Индекс](#Индекс)
   * [Тип](#Тип)
   * [Документ](#Документ)
   * [Mapping](#mapping)
5. [API](#api)
   * [Index API](#index-api)
   * [Document API](#document-api)
   * [Search API](#search-api)
   * [Cat API](#cat-api)
   * [Cluster API](#cluster-api)
6. [DSL запросов](#dsl-запросов)
   * [Фильтры](#Фильтры)
   * [Запросы](#Запросы)
   * [Комбинация утверждений при помощи логических операций](#Комбинация-утверждений-при-помощи-логических-операций)
   * [Агрегирование данных](#Агрегирование-данных)
7. [Установка и настройка](#Установка-и-настройка)

## Введение

ElasticSearch относительно молодой программный продукт, который завоевал большую популярность среди пользователей.
Он относится к категории локальных поисковых движков, хотя может использоваться как самостоятельная 
документо-ориентированная СУБД. При разработке ElasticSearch были заложены прекрасные идеи, благодаря которым он стал
столь мощным инструментом. Это, и заложенная в архитектуру возможность горизонтального масштабирования, и REST API для взаимодействия
с клиентом, и конечно мощнейший DSL запросов предоставляющий возможности точного, частичного, нечеткого и полнотекстового поиска.
Владение данным инструментом откроет перед Вами почти неограниченные возможности поиска данных.

## Подготовка окружения

Для использования в окружении разработчика, и просто, для проведения экспериментов, будет достаточно развернуть ElasticSearch
на базе Docker-контейнера.

```sh
# Создаем том для данных
$ docker volume create elastic_search_data
```

```sh
# Запускаем контейнер с СУБД
 $ docker run -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" -v elastic_search_data:/usr/share/elasticsearch/data docker.elastic.co/elasticsearch/elasticsearch:6.2.1
```

## Архитектура

### Топология кластера

  Кластер в ElasticSearch может иметь несколько конфигураций в зависимости от требований.
  Каждая нода в кластере может иметь одну из нескольких ролей:
  * Master
  * Data
  * Ingest (более подробно [здесь](https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html))
  * Coordinator
  * Tribe

#### Master node

  Несколько нод в кластере могут иметь статус Master-node, но только одна из них может быть активна. Активная мастер-нода
  выбирается на основе особого [алгоритма](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-zen.html#master-election)
  выборов. 

  Назначение Master-node - сбор и поддержание информации о состоянии кластера, принятие решения о размещении данных в кластере (операции с индексами),
  также, мастер-нода, как и нода данных размещает у себя данные, участвует в обмене данными в кластере для выполнения запросов и может выступать в
  роли координатора запросов.

  В больших кластерах мастер-ноды желательно изолировать от прямых клиентских запросов. Эти ноды должны иметь минимально-возможную нагрузку.

  Имейте в виду, что минимальное кол-во потенциальных мастер-нод должно быть определено параметром конфигурации *minimum_master_nodes*, во избежании
  состояния split brain. Более подробно можно почитать [здесь](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#split-brain).

#### Data node

  Выполняет функции хранения данных, отвечает на запросы клиентов, может выступать в роли координатора запроса.

#### Ingest node

Ноды которые могут выполнять пре-процессинг данных перед их индексированием. В некоторых топологиях выделенные ноды такого типа, 
вполне, могут иметь место.

#### Coordinator

Если у ноды выключить все флаги типов, такие как: node.master, node.data, node.ingest, search.remote.connect, то нода превращается
в координатор выполнения запросов и не хранит у себя никаких данных. Такие ноды можно рассматривать, как баллансировщики нагрузки.
Они вполне оправданы в больших кластерах. Запросы от клиентов направляются только на эти ноды, избавляя ноды данных от необходимости 
коррдинации запросов.

#### Tribe node

Особый тип координационного узла способный координировать запросы между несколькими кластерами. Требует дополнительно конфигурации (tribe.*)

### Внутреннеe устройство ноды
  
  Данные индексов, ElasticSearch хранит в так называемых шардах(shards). Каждый индекс может содержать несколько первичных
  шардов и определенное кол-во реплик каждого первичного шарда. Эти параметры задаются при создании индекса.
  Шарды дают возможность масштабировать индекс по горизонтали, другими словами, позволяют распределеять индекс на нескольких
  нодах. Индекс состоящий из одного шарда не может быть масштабирован на несколько нод. Кол-во шардов, по умолчанию, равно пяти.
  Реплики шардов служат для обеспечения отказоустойчивости кластера. Кол-во шардов указывается единожды, при создании индекса,
  и не может быть изменено позднее, кол-во реплик можно менять динамически в любое время.

## Модель данных

### Индекс

Все данные внутри ElasticSearch хранятся в индексах. Это аналог БД в реляционных СУБД. Является контейнером для типов.

### Тип

Тип - это коллекция документов определенного типа. Ближайший аналог - таблица, в реляционных СУБД. Каждый индекс может содержать
несколько типов.

### Документ

Данные в ElasticSearch хранятся в виде документов. Ближайший аналог - строка в реляционных БД, но в отличии от последней,
документ может иметь иерархическую структуру, т.е. иметь вложенные поддокументы.

### Mapping

Mapping - это описание схемы документа. Т.к. ElasticSearch взаимодействует с внешним миром посредством обмена данными в формате JSON, он
должен иметь возможность правильно интерпретировать типы данных, которые изначатьно находяться в текстововм виде внутри 
структуры JSON. Для этой цели используются Mappings.

Более подробно [здесь](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html) 

## API

Все операции с ElasticSearch осуществляются через набор REST API.

### Index API

ElasticSearch имеет, достаточно обширное, API для работы с индексами.
Более подробно с API управления индексами можно познакомиться
[здесь](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices.html) (смотрите дерево заголовков справа)

### Document API

Для создания, обновления, удаления и т.д. документов в ElasticSearch существует отдельное API.
Прочитать о нем можно [здесь](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs.html) (смотрите дерево заголовков справа)

### Search API

Для управления процедурой поиска существует API, прочитать о котором можно [здесь](https://www.elastic.co/guide/en/elasticsearch/reference/current/search.html) (смотрите дерево заголовков справа)

### Cat API

Для просмотра заголовков индексов, нод, алиасов и т.д. существует Сat API.
Более подробно можно прочитать [здесь](https://www.elastic.co/guide/en/elasticsearch/reference/current/cat.html) (смотрите на дерево подзаголовков справа)

### Cluster API

ElasticSearch предоставляет богатый API для контроля кластера. С помощью данного API
Вы можете отслеживать состояние кластера, нод и т.д.
Более подробно можно почитать [здесь](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster.html) (смотрите на дерево подзаголовков справа)

## DSL запросов

Поисковый запрос в ElasticSearch состоит из двух основных секций: фильтры(filter) и запросы(query).

Фильтры служат для точного отбора данных по условию без вычисления релевантности для каждого результата,
запросы же позволяют искать данные по степени схожести, каждый результат такого запроса имеет коэффициент релевантности.

* filter - четкие утверждения
* query - степень соответствия

Фильтры и запросы можно использовать в одном запросе одновременно, для этого они должны быть помещены в секцию filtered.

```sh
$ curl -X GET 'elasticsearch:9200/<index>/<type>/_search' -d \
"{
  "query" : {
    "filtered" : {
      "filter" : { ... },
      "query" : { ... }
    }
  }
}"
```

Интерпретировать такую запись нужно как - результаты запроса(query), отфильтрованные(filtered) по фильтру(filter)

#### Фильтры

Для опеределения фильтров используются подсекции-утверждения term, terms, range, exsists, missing.

* term - равно (аналог знака '=' в SQL )
* terms - вхождение в множество (аналог оператора IN в SQL)
* range - промежуток описанный неравенством (аналог операторов '>', '<', '<=', '>=' объединенные логическим AND в SQL)
* exists - наличие объекта (аналог IS NOT NULL в SQL)
* missing - отсутствие объекта (аналог IS NULL в SQL) 

#### Запросы

Секция query содержит подсекции:

* Утверждения (более подробно [здесь](https://www.elastic.co/guide/en/elasticsearch/reference/current/term-level-queries.html))
  * term - точное совпадение
  * terms - вхождение в множество
  * exists - наличие объекта
  * prefix - совпадение с начала строки
  * wildcard - совпадение по маске
  * regexp - совпадение по регулярному выражению
  * fuzzy - расстояние Ливенштейна
* Полнотекстовый поиск (более подробно [здесь](https://www.elastic.co/guide/en/elasticsearch/reference/current/full-text-queries.html))
  * match - полнотекстовый поиск
  * multi_match - полнотекстовый поиск по группе полей
  * match_phrase - слова расположенные рядом
  * match_phrase_prefix - слова расположенные рядом с начала строки

Каждая подсекция содержит достаточно много параметров для того, чтобы их рассматривать в этом пособии. Более подробно о каждой секции 
Вы можете прочитать [здесь](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html)

#### Комбинация утверждений при помощи логических операций

Элементы фильтров и запросов можно комбинировать при помощи логических операторов: AND, OR и NOT. Их аналоги в ElasticSearch - секции
must, should и must_not соответственно. Все объединения, при помощи логических операций, размещаются в секции bool. Секции bool
могут быть многократно вложенными. 

* must - объединяет логическим И свои элементы
* must_not - объединяет логическим И свои элементы инвертируя их значения
* should - объединяет логическим ИЛИ свои элементы

```sh
$ curl -X GET 'elasticsearch:9200/<index>/<type>/_search' -d \
"{
  "query" : {
    "filtered" : {
      "filter" : {
        "bool" : {
          "should" : [
            { "term" : { "field" : "value" } },
            { 
              "bool" : {
                must: {
                 "field" : "value",
                 "field" : "value"
                } 
              }
            }
          ],
          "must_not" : {
            "term" : { "field" : "value" }
          }
        }
      }
    }
  }
}"
```

Порядок выражений в секции bool должен быть упорядоченным по ожидаемому кол-ву результатов от каждого утверждения.
Это позволит повысить производительность запроса. Если утверждение А ограничивыет выборку до 10 миллионов документов,
а утверждение B до 10 документов, то выражение B должно идти первым в секции bool.

### Агрегирование данных

Агрегирование результатов запросов в ElasticSearch достаточно обширная тема.
Более простыми словами агрегация данных - это нахождения таких статистических параметров, возвращенных запросом 
резултатов, таких как: кол-во документов, сумма значений поля, среднее значение поля и т.д.
Аналогичные операции выполняет оператор GROUP в SQL.

Более подробно [здесь](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html)

## Установка и настройка

Настройка ElasticSearch очень хорошо описана в официальной [документации](https://www.elastic.co/guide/en/elasticsearch/reference/current/setup.html)(смотри дерево заголовков справа)
